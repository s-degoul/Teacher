<?php

// which type of evaluation is about ? educational diagnosis or evaluation at the end of an educational cycle ?
if (isset ($_GET['type_eval'])) {

	if ($_GET['type_eval'] == 'educ_diag') {
		// does educationnal diagnosis exists, and if so is it achieved ?
		require (MODEL_PATH.'select_educ_diag_exist.php');

		if (empty ($educ_diag)) {
			$messages['error'][] = _("Aucun diagnostic éducatif réalisé");
		}
		else {
			$id_educ_diag = $educ_diag['id_educ_diag'];
			if ($educ_diag['educ_diag_achieved'] != 1) {
				$messages['error'][] = _("Le diagnostic éducatif concerné n'est pas terminé ! Vous ne pouvez donc visualisez sa synthèse");
			}
			else {
				// to select the summary of educational diagnosis in database. return an array ($educ_diag_summ)
				require (MODEL_PATH.'select_educ_diag_summ.php');
				$list_answers = $educ_diag_summ;
			}
		}
	}

	elseif ($_GET['type_eval'] == 'cycle_educ_eval'){
		if (!isset ($_GET['id_eval'])) {
			$messages['info'][] = _("Il s'agit de la synthèse de la dernière évaluation en date");
			require (MODEL_PATH.'select_last_cycle_educ_achieved.php');
		}
		else {
			$id_cycle_educ = $_GET['id_eval'];
		}

		// to select the summary of educational cycle in database. return an array ($cycle_educ)
		require (MODEL_PATH.'select_cycle_educ_summ.php');
		$list_answers = $cycle_educ;
		
		// if evaluation hasn't been finished, error
		if (empty ($list_answers['cycle_educ_eval_date']) or $list_answers['cycle_educ_eval_date'] == '0000-00-00 00:00:00')
			$messages['error'][] = _("Vous ne pouvez accéder à cette synthèse tant que l'évaluation finale n'a pas été finalisée");
		
		$cycle_educ_start_date = $list_answers['cycle_educ_start_date'];
		unset ($list_answers['cycle_educ_start_date']);
		unset ($list_answers['cycle_educ_eval_date']);
	}
}
// if no type of evaluation defined, error
else {
	$messages['error'][] = _("Aucun type d'évaluation précisé");
}





// if no previous error
if (empty ($messages['error'])) {
	
	require ('group_questions.php');
	
	// to make list of educational objectives
	require (MODEL_PATH.'select_target_list.php');

	// an array to store all educational objectives the patient have to work
	// some are compulsory (not validated safety educational objectives), some only advised (other not validated educational objectives)
	$targets_to_work = array(
							'compulsory' => array(),
							'advised' => array(),
							'other' => array()
						);

	// an array to store all answers given previously, with corresponding number of educational objective
	$list_question_obj = array();


	// we scan all answers previously given (in educational diagnostic or final evaluation)
	foreach ($list_answers as $id_question => $value_question) {
		
		// to extract educational objective number ($id_target) from field name in database (named as ..._objx[_y] )
		$id_question_part = explode ('j', $id_question);
		$nb_question = $id_question_part[1];
		$nb_question_part = explode ('_', $nb_question);
		$id_target = $nb_question_part[0];

		if (!isset ($list_question_obj[$id_target])) {
			$list_question_obj[$id_target] = array (
													'target_name' => $list_target[$id_target]['target_name'],
													'target_security' => $list_target[$id_target]['target_security'],
													'value_question' => '' // will be defined just after
													);							
		}
		
		// as some educational objectives are divided in two subquestions (a and b) ...
		if (empty ($list_question_obj[$id_target]['value_question'])) {
			if (isset ($nb_question_part[1]))
				$list_question_obj[$id_target]['value_question'] = array ($nb_question_part[1] => $value_question);
			else
				$list_question_obj[$id_target]['value_question'] = array (0 => $value_question);		
		}
		else {
			$nb_subquestion = $nb_question_part[1];
			$list_question_obj[$id_target]['value_question'][$nb_subquestion] = $value_question;
		}



		// to fill array "targets to work" in, according to number of points and "compulsory, advised or not"
		
		// if it's a safety objective and it isn't validated (value < 2)
		if ($value_question < 2 and $list_question_obj[$id_target]['target_security'] == 1) {
			if (!in_array ($id_target, $targets_to_work['compulsory']))
				$targets_to_work['compulsory'][] = $id_target;
				
			// for objectives with subquestions : if first subquestion has ever been registered in $targets_to_work['other'] because it was validated ...
			if (in_array ($id_target, $targets_to_work['other'])) {
				$key = array_search ($id_target, $targets_to_work['other']);
				unset ($targets_to_work['other'][$key]);
			}
		}
		// if it isn't a safety objective and isn't validated (value < 1)
		elseif ($value_question < 1 and $list_question_obj[$id_target]['target_security'] == 0) {
			if (!in_array ($id_target, $targets_to_work['advised']))
				$targets_to_work['advised'][] = $id_target;
			
			// for objectives with subquestions : if first subquestion has ever been registered in $targets_to_work['other'] because it was validated ...
			if (in_array ($id_target, $targets_to_work['other'])) {
				$key = array_search ($id_target, $targets_to_work['other']);
				unset ($targets_to_work['other'][$key]);
			}
		}
		// objectives which have been validated are put in $targets_to_work['other']
		else {
			if (!in_array ($id_target, $targets_to_work['other'])
				and !in_array ($id_target, $targets_to_work['compulsory'])
				and !in_array ($id_target, $targets_to_work['advised']))
				$targets_to_work['other'][] = $id_target;
		}
	}



	// to select next educational cycle (which doesn't exist yet in case we are in synthesis of educational diagnosis)
	
	// next eductional cycle is defined by a date posterior to evaluation of concern now
	if ($_GET['type_eval'] == 'educ_diag')
		$date_min = $educ_diag['educ_diag_date'];
	elseif ($_GET['type_eval'] == 'cycle_educ_eval')
		$date_min = $cycle_educ_start_date;

	require (MODEL_PATH.'select_next_cycle_educ.php');
	
	// if no next educational cycle exists, we create one
	if ($nb_response == 0) {
		require (MODEL_PATH.'insert_cycle_educ.php'); // return Id of educational cycle ($id_cycle_educ)
		$view_action = 'write';
	}
	// else if one exists, we select its informations
	elseif ($nb_response == 1) {
		$id_cycle_educ = $id_next_cycle_educ;
		require (MODEL_PATH.'select_list_cycle_target.php');
		
		// have final evaluation of this cycle already made ?
		require (MODEL_PATH.'select_cycle_educ_eval_date.php');
		// if so, we could only read the list of scheduled objectives
		if ($cycle_educ_eval_date != '') {
			$view_action = 'read';
		}
		// if not, possibility of modifications depends on if objectives have ever been scheduled or not ...
		else {
			if (empty ($list_cycle_target) and !empty ($targets_to_work['compulsory']))
				$view_action = 'write';
			elseif (isset ($_SESSION['id_patient']['warning']))
				$view_action = 'write';
			elseif (isset ($_GET['modify_target_cycle']))
				$view_action = 'write';
			else
				$view_action = 'read';
		}

	}
	else {
		$messages['error'][] = _("Il y a plusieurs cycles du programme éducatif avec la même date de début pour ce patient. Veuillez contacter l'administrateur du site");
	}


		
/*	
echo '<pre>';
print_r ($targets_to_work);
echo '</pre>';
*/

	// management of data sent, corresponding to registration of educational objectives in the programme
	if (isset ($_POST['valid_targets_to_work'])) {
		$targets_cycle = checkVarPost ();
		
		// we go through the list of objectives to work previously defined
		foreach ($targets_to_work as $targets_importance => $list_targets_to_work) {
			foreach ($list_targets_to_work as $key => $nb_target_to_work) {
				
				// check of possible error
				// if objective haven't been checked whereas it's compulsory (-> error) or advised (-> warning)
				if (!isset ($targets_cycle['confirm_target_'.$nb_target_to_work])) {
					if ($targets_importance == 'compulsory') {
						$messages['error'][$nb_target_to_work] = _("Vous devez sélectionner l'objectif n°").' '.$nb_target_to_work;
					}
					elseif ($targets_importance == 'advised') {
						if (!isset ($_SESSION['id_patient']['warning'][$nb_target_to_work])) {
							$messages['warning'][$nb_target_to_work] = _("Etes-vous sur de ne pas prévoir de travailler l'objectif n°").' '.$nb_target_to_work.' ?';
							$_SESSION['id_patient']['warning'][$nb_target_to_work] = 1;
						}
						else {
							$_SESSION['id_patient']['warning'][$nb_target_to_work] = 2;
						}
					}
				}
				// if no date have been given whereas objective is compulsory or advised (-> warning)
				elseif (empty ($targets_cycle['date_target_'.$nb_target_to_work])) {
					if ($targets_importance == 'compulsory' or $targets_importance == 'advised') {
						if (!isset ($_SESSION['id_patient']['warning'][$nb_target_to_work])) {
							$messages['warning'][$nb_target_to_work] = _("Etes-vous sur de ne pas prévoir de date pour l'objectif n°").' '.$nb_target_to_work.' ?';
							$_SESSION['id_patient']['warning'][$nb_target_to_work] = 1;
						}
						else {
							$_SESSION['id_patient']['warning'][$nb_target_to_work] = 2;
						}
					}
					$target_date = '';
				}
				// check of date given
				elseif (!empty ($targets_cycle['date_target_'.$nb_target_to_work])) {
					$targets_cycle['confirm_target_'.$nb_target_to_work] = 1;
					
					$target_date_parts = explode ('/', $targets_cycle['date_target_'.$nb_target_to_work]);
					if ( !isset ($target_date_parts[1]) or !isset ($target_date_parts[2])) {
						$messages['error'][$nb_target_to_work] = _("Le format de la date n'est pas correct");
						$targets_cycle['date_target_'.$nb_target_to_work] = '';	
					}
					else {
						$target_date = prepareDateSQL ($target_date_parts[2], $target_date_parts[1], $target_date_parts[0]);
						
						if (checkdate ($target_date_parts[1], $target_date_parts[0], $target_date_parts[2]) == false
							or calculateAge ($target_date) >= 0) {
							$messages['error'][$nb_target_to_work] = _("La date entrée n'est pas correcte pour l'objectif n°").' '.$nb_target_to_work;
						}
					}	
				}
			
				// if no error and no warning message (or warning message but exception confirmed by user) :
				// insertion or update in database
				if (isset ($targets_cycle['confirm_target_'.$nb_target_to_work])
				and empty ($messages['error'][$nb_target_to_work])
				and empty($messages['warning'][$nb_target_to_work])) {
					//or (!empty ($messages['warning']) and isset ($_SESSION['warning'][$nb_target_to_work]) and $_SESSION['warning'][$nb_target_to_work] == 2))) {
					$id_target = $nb_target_to_work;
					$target_done = 0;
					if ($target_date == '')
						$target_date = NULL;
					
					require (MODEL_PATH.'select_cycle_target_exist.php');
					if (empty ($cycle_target))
						require (MODEL_PATH.'insert_cycle_target.php');
					else
						require (MODEL_PATH.'update_cycle_target.php');
						
					if (isset ($_SESSION['id_patient']['warning'][$nb_target_to_work]))	
						unset ($_SESSION['id_patient']['warning'][$nb_target_to_work]);
				}	
			}
		}	

	}
	
	elseif (isset ($_POST['valid_programme'])) {
		if (!empty ($targets_to_work['compulsory'])) {
			$messages['error'][] = _("Vous ne pouvez pas achever le programme éducatif tant qu'il reste
									au moins un objectif de sécurité non validé");
		}
		elseif (!empty ($targets_to_work['advised']) and !isset($_SESSION['id_patient']['warning']['programme_finished'])) {
			$messages['warning'][] = _("Êtes-vous sûr d'achever ce programme éducatif alors que certains objectifs ne sont pas validés ?");
			$_SESSION['id_patient']['warning']['programme_finished'] = 1;
		}
		else {
			require (MODEL_PATH.'select_last_cycle_educ_achieved.php');
			require (MODEL_PATH.'update_cycle_educ_end_programme.php');
			
			$user_eval_to_do = 1;
			require (MODEL_PATH.'update_user_eval_to_do.php');
			$_SESSION['user_eval_to_do'] = 1;
			
			require (MODEL_PATH.'select_cycle_educ_exist.php');
			
			define ('NB_MONTHS_LATER', 6);
			
			$future_eval_date_y = date('Y');
			$future_eval_date_m = date('m') + NB_MONTHS_LATER;
			
			if (date('m') > 12 - NB_MONTHS_LATER) {
				$future_eval_date_y += 1;
				$future_eval_date_m -= 12;
			}
		
			$cycle_educ_eval_date = $future_eval_date_y.'-'.$future_eval_date_m.'-00 00:00:00';
			require (MODEL_PATH.'update_cycle_educ_eval_date.php');
			require (MODEL_PATH.'delete_cycle_target.php');
			
			if (isset ($_SESSION['id_patient']['warning']['programme_finished']))
				unset ($_SESSION['id_patient']['warning']['programme_finished']);
				
			header ('location:.?module=patient_management&action=show_profile');
		}
	}
	

	require (VIEW_RELATIVE_PATH.'show_summ_eval.php');
}
?>
